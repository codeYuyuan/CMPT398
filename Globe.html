
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
    <title>Globe</title>  
  	<style>

		.map_path {
			stroke: black;
			stroke-width: 1;
		}

		.grid_path{
			stroke: gray;
			stroke-width: 1;
			fill:none;
			opacity: 1;
		}

	</style>
</head> 

<body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js'></script>
</script>
<script>

		//Polution data
		var countries = [];

		var PM10min = 99999;
		var PM10max = 0;
		var PM10avg = 0;
		var PM10s = [];

		var PM25min = 99999;
		var PM25max = 0;
		var PM25avg = 0;
		var PM25s = [];

		//Color scales
		var PM10Scale;
		var PM25Scale;

		var globe = [];
		var details = {};
		//get data from CSV
		d3.csv("./who-aap-database-countries-may2016.csv", function (data) {
			data.forEach(c => {
				countries.push({
					Country: c.Country,
					Cities: parseInt(c.Cities),
					PM10: parseInt(c.PM10),
					PM25: parseInt(c.PM25)
				});
				PM10s.push(parseInt(c.PM10));
				PM25s.push(parseInt(c.PM25));
			});
			PM10s.sort(function (a, b) { return a.PM10 - b.PM10 });
			PM25s.sort(function (a, b) { return a.PM25 - b.PM25 });

			d3.csv("./who-aap-database-may2016-detail.csv",function(data){
				data.forEach(r => {
					 if(r.Country in details){
					 	var info = {city: r.City,
					 				PM10: r.PM10,
					 				PM25: r.PM25};
					 	details[r.Country].push(info);
					 }else{
					 	details[r.Country] = new Array();
					 	var info = {city: r.City,
					 				PM10: r.PM10,
					 				PM25: r.PM25};
					 	details[r.Country].push(info);
					 }
				
				});
				 // console.log(details);
			});
			PMData();
			visualization();
		});


		function PMData() {
			console.log("here");
			//Find min, max, and average for PM10 and PM2.5 
			countries.forEach(c => {

				//console.log(PM10max);
				//find min and max
				if (c.PM10 > PM10max) {
					PM10max = c.PM10;
					//console.log(PM10max);
					//console.log(c);
				}
				else if (c.PM10 < PM10min) {
					PM10min = c.PM10;
				}

				if (c.PM25 > PM25max) {
					PM25max = c.PM25;
				}
				else if (c.PM25 < PM25min) {
					PM25min = c.PM25;
				}

				PM10avg += c.PM10;
				PM25avg += c.PM25;
			});

			PM10avg /= countries.length;
			PM25avg /= countries.length;

			// PM10Scale = function(PM10)
			// {

			// }
			PM10Scale = d3.scaleQuantile()
				.domain(PM10s)
				.range([255, 170, 85, 0]);

			PM25Scale = d3.scaleQuantile()
				.domain([PM25s])
				.range([255, 170, 85, 0]);

			console.log("Min " + PM10min);
			console.log("Max " + PM10max);
			console.log("Avg " + PM10avg);
		}

		function getColor(data) {
			//console.log(data.properties.name);
			var country = countries.find(function (c) {
				//Some country names have multiple forms (USA, U.S.A., United States of America) etc.
				//so compare each country name from the pollution database to each property of the
				//selected country
				if (Object.values(data.properties).find(function (d) {
					if (c.Country == d) {
						return true;
					}
				})) {
					return c.Country;
				}

				//== data.properties.name;
			});
			//console.log(country);

			if (country != null) {
				var scale = Math.round(PM10Scale(country.PM10));
				//console.log("rbga(255," + scale + "," + scale + ",1)");
				// console.log(country.Country);
				// console.log("    PM10: " + country.PM10);
				// console.log("rbga(255," + scale + "," + scale + ",1)");
				return "rgba(255," + scale + "," + scale + ",1)";
			}
			else {
				return "gray";
			}
		}

	function visualization() {
		var width = document.documentElement.clientWidth;
		var height = document.documentElement.clientHeight;
		var speed = 0.5;
		var isMouseOn = false;
		
		var svg = d3.select("body").append("svg")
		    .attr("width", width)
		    .attr("height", height);
		
		var projection = d3.geoOrthographic()
				.scale(300);

		var graticule = d3.geoGraticule();

		
		var path = d3.geoPath()
						.projection(projection);
		
		var color = "gray";
		
		svg.append("text")
			.attr("id","loading")
			.attr("x",width/2)
			.attr("y",height/2)
			.text("Now Loading...");
		
		d3.json("world_605kb.json", function(error, root) {
			if (error) 
				return console.error(error);
			console.log(root);
			
			var grid = graticule();
			
			console.log(grid);
			
			var map = svg.append("g")
						.attr("transform", "translate(" + 0 + "," + 50 + ")");
					//.attr("transform", "translate(" + -230 + "," + -20 + ")");
			map.append("path")
				.datum( grid )
				.attr("id","grid_id")
				.attr("class","grid_path")
				.attr("d",path);
			
			map.selectAll(".map_path")
					.data( root.features )
					.enter()
					.append("path")
					.attr("class","map_path")
					.attr("fill",function(d,i){
						// console.log(d);
						return getColor(d);//color(i);
					})
					.attr("d", path )
					.on("mouseover",function(d,i){
						console.log(d);
						var countryName = d.properties.BRK_NAME;
						console.log(countryName);
						for(var key in details){
							if(key.includes(countryName)){
								countryName = key;
								break;
							}
						}
						console.log(details[countryName]);
						isMouseOn = true;
						d3.select(this)
							.attr("fill","yellow");
					})
					.on("mouseout",function(d,i){
						isMouseOn = false;
						d3.select(this)
							.attr("fill",getColor(d));
					});;

			svg.select("#loading")
				.attr("opacity",0);
			

			
			var offset = 0;
			var positionLock = 0;
			currentDegree = 0;

			d3.timer(function() {
				if(!isMouseOn){
					projection.rotate([speed * (currentDegree++), -15]).clipAngle(90);
				}
				map.select("#grid_id")
					.attr("d",path);
				
				map.selectAll(".map_path")
					.attr("d",path);

				
			});
			
		});
	};
	

</script>
	</body>
</html>